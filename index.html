/* ===== シート読込：公開URL(2PACX)をTSVで読む ===== */
const SHEET_TSV =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRVC56sLRh94LTed5WD4sVkIojw00CTlBL7yPtJocPewWqQ-ODfFsmLx_k9BX3LOmNT8ztP4GwqJVfl/pub?gid=0&single=true&output=tsv';

let items = [], idx = 0, passFlags = [], sessionStart = null;

(async function loadSheet(){
  try{
    const res = await fetch(SHEET_TSV + '&_ts=' + Date.now(), { cache:'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const tsv = await res.text();

    // TSV を安全に分割（カンマや引用符問題を回避）
    const rows = tsv.trim().split(/\r?\n/).map(line => line.split('\t'));
    const [header, ...data] = rows;
    const norm = s => String(s||'').trim().toLowerCase();
    const qi = header.findIndex(h => /question/.test(norm(h)));
    const ai = header.findIndex(h => /answer/.test(norm(h)));
    const ji = header.findIndex(h => /japanese/.test(norm(h)));
    if (qi < 0 || ai < 0) throw new Error('ヘッダに Question / Answer がありません');

    items = data
      .map(r => ({ q: r[qi]||'', a: (r[ai]||'').toLowerCase(), j: ji>=0 ? (r[ji]||'') : '' }))
      .filter(x => x.q || x.a);

    if (!items.length) throw new Error('有効な行がありません');
    passFlags = items.map(()=>false);
    idx = 0;
    render();
  }catch(e){
    console.error('TSV load error:', e);
    document.getElementById('q').textContent = 'Load error: ' + e.message;
  }
})();
