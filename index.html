<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’ï¼ˆè´ãâ†’è©±ã™â†’ãƒã‚§ãƒƒã‚¯ï¼‰</title>
<style>
  :root{--fg:#0f172a;--muted:#64748b;--accent:#2563eb;--ok:#0a7a0a;--ng:#c01818;--bd:#e2e8f0;}
  *{box-sizing:border-box}
  body{color:var(--fg);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;margin:0;background:#fff;}
  .wrap{max-width:860px;margin:24px auto 64px;padding:0 16px}
  header.card,section.card,footer.card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:16px 20px;box-shadow:0 1px 8px rgba(2,6,23,.05);margin-bottom:16px}
  h1{margin:0 0 6px 0;font-weight:800;letter-spacing:.2px;font-size:clamp(24px,4.5vw,42px)}
  .progress{font-size:13px;color:var(--muted);margin-bottom:2px}
  #q{font-size:clamp(22px,5vw,44px);font-weight:700;letter-spacing:.2px;margin:6px 0 10px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btn{appearance:none;border:1px solid var(--bd);background:#fff;color:var(--fg);padding:14px 20px;border-radius:999px;cursor:pointer;font-weight:700;font-size:18px;min-width:120px;box-shadow:0 1px 4px rgba(2,6,23,.04);transition:.15s}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--accent);color:#fff;border-color:transparent}
  .btn-ghost{background:#f8fafc}
  .btn-wide{min-width:140px}
  .btn[disabled]{opacity:.45;cursor:not-allowed}
  #live{opacity:.7;white-space:pre-wrap;margin-top:8px}
  #final{white-space:pre-wrap;margin-top:8px}
  #score{font-weight:800;margin-top:12px}
  .ok{color:var(--ok)} .ng{color:var(--ng)}
  .hint{color:var(--muted);font-size:14px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;border:1px solid var(--bd);padding:2px 6px;border-radius:6px;background:#f8fafc}
  @media (hover:hover){.btn:hover{box-shadow:0 3px 10px rgba(2,6,23,.08)}}
</style>

<div class="wrap">
  <!-- ä½¿ã„æ–¹ -->
  <header class="card">
    <div class="progress">ä½¿ã„æ–¹</div>
    <div class="hint">â‘  <span class="kbd">å†ç”Ÿ</span>ã§å•é¡Œã‚’èã â†’ â‘¡ <span class="kbd">éŒ²éŸ³é–‹å§‹</span>ã§ç­”ãˆã‚‹ â†’ â‘¢ <span class="kbd">ãƒã‚§ãƒƒã‚¯</span>ã§çµæœã‚’è¦‹ã‚‹</div>
  </header>

  <!-- å‡ºé¡Œ -->
  <section class="card">
    <div class="progress">å•é¡Œ <span id="prog"></span></div>
    <h1 id="q">Loading...</h1>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡Œï¼šå·¦ç«¯ã«ã€Œå†ç”Ÿã€ã€å‰ã¸ã¯å‰Šé™¤ -->
    <div class="row" style="margin-top:8px">
      <button id="play" class="btn btn-ghost">ğŸ”Š å†ç”Ÿ</button>
      <button id="rec"  class="btn btn-primary btn-wide">ğŸ¤ éŒ²éŸ³é–‹å§‹</button>
      <button id="grade" class="btn btn-ghost">âœ… ãƒã‚§ãƒƒã‚¯</button>
      <button id="next" class="btn btn-ghost" disabled>æ¬¡ã¸ âŸ¶</button>
    </div>

    <div id="live"></div>
    <div id="final"></div>
    <div id="score"></div>
  </section>

  <!-- æ“ä½œã®ãƒ’ãƒ³ãƒˆ -->
  <footer class="card">
    <div class="progress">ãƒ’ãƒ³ãƒˆ</div>
    <div class="hint">éŸ³é‡ãŒå°ã•ã„ã¨èªè­˜ç²¾åº¦ãŒè½ã¡ã¾ã™ã€‚ã¯ã£ãã‚Šãƒ»åŒºåˆ‡ã£ã¦è©±ã—ã¾ã—ã‚‡ã†ã€‚éŒ²éŸ³ä¸­ã¯ãƒœã‚¿ãƒ³ãŒã€ŒğŸŸ¥ éŒ²éŸ³ä¸­ã€ã«å¤‰ã‚ã‚Šã¾ã™ã€‚</div>
  </footer>

  <!-- ãƒã‚§ãƒƒã‚¯å¾Œã«å‡ºã™ æ—¥æœ¬èªè¨³ -->
  <section class="card" id="jaCard" style="display:none;">
    <div class="progress">è³ªå•ã®æ„å‘³ï¼ˆæ—¥æœ¬èªè¨³ï¼‰</div>
    <div id="jaText" class="hint"></div>
  </section>

  <!-- å…¨å•çµ‚äº†å¾Œã®æ™‚é–“è¡¨ç¤º -->
  <section class="card" id="timeCard" style="display:none;">
    <div class="progress">çµæœ</div>
    <div id="timeText"></div>
  </section>
</div>

<script>
/* ===== åŸºæœ¬è¨­å®š ===== */
const SHEET_CSV='https://docs.google.com/spreadsheets/d/e/2PACX-1vRVC56sLRh94LTed5WD4sVkIojw00CTlBL7yPtJocPewWqQ-ODfFsmLx_k9BX3LOmNT8ztP4GwqJVfl/pub?gid=0&single=true&output=csv';
const STT_API='/api/transcribe';
const LANG_VOICE='en-US';      // TTS/æš«å®šå­—å¹•
const LANG_WHISPER='en';       // Whisper
const PASS_THRESHOLD = 0.80;   // é¡ä¼¼ç‡ 80%

/* ===== CSV èª­è¾¼ï¼ˆå …ç‰¢ç‰ˆï¼‰ ===== */
let items = [], idx = 0, passFlags = [], sessionStart = null;

function parseCSV(text){
  const rows = [];
  let row = [], cur = '', inQ = false;
  for (let i = 0; i < text.length; i++){
    const c = text[i], n = text[i+1];
    if (inQ){
      if (c === '"' && n === '"'){ cur += '"'; i++; }
      else if (c === '"'){ inQ = false; }
      else { cur += c; }
    } else {
      if (c === '"'){ inQ = true; }
      else if (c === ','){ row.push(cur); cur = ''; }
      else if (c === '\n'){ row.push(cur); rows.push(row); row = []; cur = ''; }
      else if (c === '\r'){ /* skip */ }
      else { cur += c; }
    }
  }
  row.push(cur); rows.push(row);
  return rows.filter(r => r.length && !(r.length===1 && r[0]===''));
}

(async function loadSheet(){
  try{
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), 8000); // 8ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    const res = await fetch(
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vRVC56sLRh94LTed5WD4sVkIojw00CTlBL7yPtJocPewWqQ-ODfFsmLx_k9BX3LOmNT8ztP4GwqJVfl/pub?gid=0&single=true&output=csv',
      { cache: 'no-store', signal: ctrl.signal }
    );
    clearTimeout(t);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const csv = await res.text();

    const rows = parseCSV(csv);
    const header = rows[0].map(h=>String(h).trim().toLowerCase());
    const qi = header.indexOf('question');
    const ai = header.indexOf('answer');
    const ji = header.indexOf('japanese'); // Cåˆ—
    if (qi < 0 || ai < 0) throw new Error('ãƒ˜ãƒƒãƒ€ã« Question / Answer ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

    items = rows.slice(1).map(r => ({
      q: r[qi] ?? '',
      a: String(r[ai] ?? '').toLowerCase(),
      j: ji >= 0 ? (r[ji] ?? '') : ''
    }));
    if (!items.length) throw new Error('ãƒ‡ãƒ¼ã‚¿è¡ŒãŒã‚ã‚Šã¾ã›ã‚“');

    passFlags = items.map(() => false);
    idx = 0;
    render();
  }catch(e){
    console.error('CSV load/parsing error:', e);
    document.getElementById('q').textContent = 'Load error: ' + (e.name === 'AbortError' ? 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ' : e.message);
  }
})();

/* ===== ç”»é¢æ›´æ–° ===== */
function render(){
  stop(true);
  const total=items.length||0;
  document.getElementById('q').textContent=items[idx]?.q||'(no question)';
  document.getElementById('prog').textContent=total?`${idx+1}/${total}`:'';
  setScore(''); setNextEnabled(false);
  // æ—¥æœ¬èªè¨³ã¨æ™‚é–“è¡¨ç¤ºã¯ä¸€æ—¦éš ã™
  document.getElementById('jaCard').style.display='none';
}

/* ===== TTSï¼ˆå†ç”Ÿãƒ»è‡ªç„¶ãªå£°ã®é¸æŠï¼‰ ===== */
let preferredVoice=null;
function chooseVoice(lang){
  const list = speechSynthesis.getVoices().filter(v=>v.lang && v.lang.startsWith(lang));
  // Googleç³»ã‚„"Natural/Premium"ã‚’å„ªå…ˆ
  const fav = list.find(v=>/google|natural|premium/i.test(v.name)) || list[0] || null;
  return fav;
}
speechSynthesis.onvoiceschanged=()=>{ preferredVoice = chooseVoice(LANG_VOICE); };

document.getElementById('play').onclick=()=>{
  if(!sessionStart) sessionStart = Date.now(); // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
  const u=new SpeechSynthesisUtterance(items[idx]?.q||'');
  u.lang=LANG_VOICE;
  if(!preferredVoice) preferredVoice = chooseVoice(LANG_VOICE);
  if(preferredVoice) u.voice = preferredVoice;
  u.rate = 1; u.pitch = 1; // å¿…è¦ãªã‚‰å¾®èª¿æ•´
  speechSynthesis.cancel(); speechSynthesis.speak(u);
};

/* ===== éŒ²éŸ³/STT ===== */
let stream,rec,chunks=[],timer,recognizing=false,recog,confirmed='',interim='';
const live=document.getElementById('live');
const finalEl=document.getElementById('final');
const recBtn=document.getElementById('rec');
const nextBtn=document.getElementById('next');

recBtn.onclick=async()=>{ if(!rec||rec.state==='inactive') start(); else stop(); };

async function start(){
  if(!sessionStart) sessionStart = Date.now(); // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆåˆå›éŒ²éŸ³ï¼‰
  confirmed=interim=''; finalEl.textContent=''; live.textContent=''; setScore('');
  if('webkitSpeechRecognition'in window||'SpeechRecognition'in window){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    recog=new SR(); recog.lang=LANG_VOICE; recog.interimResults=true; recog.continuous=true;
    recog.onresult=e=>{
      let tmp=''; for(let i=e.resultIndex;i<e.results.length;i++){const r=e.results[i];
        if(r.isFinal){confirmed+=r[0].transcript+'\n';}else{tmp+=r[0].transcript;}}
      interim=tmp; live.textContent=interim; finalEl.textContent=confirmed;
    };
    try{recog.start(); recognizing=true;}catch{}
  }
  stream=await navigator.mediaDevices.getUserMedia({audio:true});
  const mime=MediaRecorder.isTypeSupported('audio/webm')?'audio/webm':'audio/ogg';
  rec=new MediaRecorder(stream,{mimeType:mime}); chunks=[];
  rec.ondataavailable=e=>{if(e.data&&e.data.size)chunks.push(e.data);};
  rec.start(); timer=setInterval(sendChunk,3000);
  recBtn.textContent='ğŸŸ¥ éŒ²éŸ³ä¸­';
}
async function stop(silent=false){
  clearInterval(timer);
  if(rec&&rec.state!=='inactive')rec.stop();
  if(stream)stream.getTracks().forEach(t=>t.stop());
  if(recognizing&&recog){try{recog.stop();}catch{} recognizing=false;}
  if(!silent)recBtn.textContent='ğŸ¤ éŒ²éŸ³é–‹å§‹';
  if(chunks.length&&!silent)await sendChunk();
}
function toBase64(blob){return new Promise((res,rej)=>{const r=new FileReader();r.onloadend=()=>res(r.result);r.onerror=rej;r.readAsDataURL(blob);});}
async function sendChunk(){
  if(!chunks.length)return;
  const blob=new Blob(chunks.splice(0,chunks.length),{type:rec.mimeType});
  const b64=await toBase64(blob);
  const r=await fetch(STT_API,{method:'POST',headers:{'content-type':'application/json'},
    body:JSON.stringify({base64:b64.split(',')[1],mime:rec.mimeType,language:LANG_WHISPER})});
  const j=await r.json().catch(()=>({}));
  if(j&&j.text){confirmed+=j.text+'\n'; finalEl.textContent=confirmed;}
}

/* ===== ãƒã‚§ãƒƒã‚¯ï¼ˆ80%ä»¥ä¸Šã§åˆæ ¼â†’æ¬¡ã¸æœ‰åŠ¹ï¼‰ï¼‹ æ—¥æœ¬èªè¨³è¡¨ç¤º ===== */
document.getElementById('grade').onclick=()=>{
  const cand=normalize((confirmed||interim||'').trim());
  const gold=normalize(items[idx]?.a||'');
  const sim=similarity(cand,gold);
  const ok=sim>=PASS_THRESHOLD;
  setScore(ok?`åˆæ ¼ï¼ˆé¡ä¼¼åº¦ ${Math.round(sim*100)}%ï¼‰`
              :`æ®‹å¿µğŸ’¦ï¼ˆé¡ä¼¼åº¦ ${Math.round(sim*100)}%ï¼‰\nã‚ãªãŸã®å›ç­”: ${cand}\næ¨¡ç¯„è§£ç­”: ${gold}`,
           ok?'ok':'ng');
  setNextEnabled(ok);

  // æ—¥æœ¬èªè¨³ã‚’è¡¨ç¤º
  const ja = items[idx]?.j || '';
  const jaCard = document.getElementById('jaCard');
  document.getElementById('jaText').textContent = ja || 'ï¼ˆæ—¥æœ¬èªè¨³ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰';
  jaCard.style.display = 'block';

  // åˆæ ¼ã‚’è¨˜éŒ²ã—ã€å…¨å•ã‚¯ãƒªã‚¢ãªã‚‰æ™‚é–“è¨ˆæ¸¬ã‚’è¡¨ç¤º
  if(ok){ passFlags[idx]=true; maybeShowTime(); }
};
function setScore(text,cls){const el=document.getElementById('score'); el.className=cls||''; el.textContent=text;}
function setNextEnabled(b){ nextBtn.disabled = !b; }
function normalize(s){return s.toLowerCase().replace(/[^\p{Letter}\p{Number}\s]/gu,'').replace(/\s+/g,' ').trim();}
function similarity(a,b){const m=a.length,n=b.length;if(!m&&!n)return 1;const d=Array.from({length:m+1},(_,i)=>[i]);for(let j=1;j<=n;j++)d[0][j]=j;for(let i=1;i<=m;i++){for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1;d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+c);}}const dist=d[m][n];return 1-dist/Math.max(m,n);}

/* ===== æ¬¡ã¸ï¼ˆåˆæ ¼æ™‚ã®ã¿æŠ¼ã›ã‚‹ï¼‰ ===== */
nextBtn.onclick=()=>{ if(nextBtn.disabled) return; idx=(idx+1)%items.length; render(); };

/* ===== å…¨å•çµ‚äº†ã®æ™‚é–“è¡¨ç¤º ===== */
function maybeShowTime(){
  if(!sessionStart) return;
  if(passFlags.every(Boolean)){
    const ms = Date.now() - sessionStart;
    const mm = String(Math.floor(ms/60000)).padStart(2,'0');
    const ss = String(Math.floor((ms%60000)/1000)).padStart(2,'0');
    const timeCard = document.getElementById('timeCard');
    document.getElementById('timeText').textContent = `å…¨ ${items.length} å•ã‚’å®Œäº†ï¼ ã‹ã‹ã£ãŸæ™‚é–“ï¼š${mm}:${ss}`;
    timeCard.style.display = 'block';
  }
}
</script>
