<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>スピーキング練習（聴く→話す→チェック）</title>
<style>
  :root{--fg:#0f172a;--muted:#64748b;--accent:#2563eb;--ok:#0a7a0a;--ng:#c01818;--bd:#e2e8f0;}
  *{box-sizing:border-box}
  body{color:var(--fg);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;margin:0;background:#fff;}
  .wrap{max-width:860px;margin:24px auto 64px;padding:0 16px}
  header.card,section.card,footer.card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:16px 20px;box-shadow:0 1px 8px rgba(2,6,23,.05);margin-bottom:16px}
  h1{margin:0 0 6px 0;font-weight:800;letter-spacing:.2px;font-size:clamp(24px,4.5vw,42px)}
  .progress{font-size:13px;color:var(--muted);margin-bottom:2px}
  #q{font-size:clamp(22px,5vw,44px);font-weight:700;letter-spacing:.2px;margin:6px 0 10px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btn{appearance:none;border:1px solid var(--bd);background:#fff;color:var(--fg);padding:14px 20px;border-radius:999px;cursor:pointer;font-weight:700;font-size:18px;min-width:120px;box-shadow:0 1px 4px rgba(2,6,23,.04);transition:.15s}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.45;cursor:not-allowed;box-shadow:none}
  .btn-primary{background:var(--accent);color:#fff;border-color:transparent}
  .btn-ghost{background:#f8fafc}
  .btn-wide{min-width:140px}
  #live{opacity:.7;white-space:pre-wrap;margin-top:8px}
  #final{white-space:pre-wrap;margin-top:8px}
  #score{font-weight:800;margin-top:12px}
  .ok{color:var(--ok)} .ng{color:var(--ng)}
  .hint{color:var(--muted);font-size:14px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;border:1px solid var(--bd);padding:2px 6px;border-radius:6px;background:#f8fafc}
  .qrow{display:flex;align-items:flex-end;justify-content:space-between;gap:12px}
  .qrow h1{margin:0}
  #timer{font-size:13px;color:var(--muted)}
  @media (hover:hover){.btn:hover{box-shadow:0 3px 10px rgba(2,6,23,.08)}}
</style>

<div class="wrap">
  <!-- 使い方 + タイマー -->
  <header class="card">
    <div class="progress" style="display:flex;justify-content:space-between;align-items:center">
      <span>使い方</span>
      <span id="timer">—</span>
    </div>
    <div class="hint">① <span class="kbd">再生</span>で問題を聞く → ② <span class="kbd">録音開始</span>で答える → ③ <span class="kbd">チェック</span>で結果を見る（合格すると「次へ」が有効）</div>
  </header>

  <!-- 出題 -->
  <section class="card">
    <div class="progress">問題 <span id="prog"></span></div>

    <!-- 問題文（右側の再生ボタンはやめ、下の操作列の左に配置） -->
    <div class="qrow">
      <h1 id="q">Loading...</h1>
    </div>

    <!-- 操作列：左から「再生」「録音開始」「チェック」「次へ」 -->
    <div class="row" style="margin-top:8px">
      <button id="play" class="btn btn-ghost">🔊 再生</button>
      <button id="rec"  class="btn btn-primary btn-wide">🎤 録音開始</button>
      <button id="grade" class="btn btn-ghost">✅ チェック</button>
      <button id="next" class="btn btn-ghost" disabled>次へ ⟶</button>
    </div>

    <div id="live"></div>
    <div id="final"></div>
    <div id="score"></div>
  </section>

  <!-- 操作のヒント -->
  <footer class="card">
    <div class="progress">ヒント</div>
    <div class="hint">音量が小さいと認識精度が落ちます。はっきり・区切って話しましょう。録音中はボタンが「🟥 録音中」に変わります。</div>
  </footer>

  <!-- チェック後に表示する日本語訳 -->
  <section id="jaCard" class="card" style="display:none">
    <div class="progress">質問の意味（日本語訳）</div>
    <div id="ja" class="hint"></div>
  </section>
</div>

<script>
/* ===== 基本設定 ===== */
const SHEET_CSV='https://docs.google.com/spreadsheets/d/e/2PACX-1vRVC56sLRh94LTed5WD4sVkIojw00CTlBL7yPtJocPewWqQ-ODfFsmLx_k9BX3LOmNT8ztP4GwqJVfl/pub?gid=0&single=true&output=csv';
const STT_API='/api/transcribe';
const LANG_VOICE='en-US';      // TTS/暫定字幕
const LANG_WHISPER='en';       // Whisper
const PASS_THRESHOLD = 0.80;   // 80% 以上で合格

/* ===== CSV 読込 ===== */
let items=[],idx=0, solved=[], startTime=null, timerId=null;
(async function loadSheet(){
  const csv=await (await fetch(SHEET_CSV,{cache:'no-store'})).text();
  const rows=csv.trim().split(/\r?\n/).map(line=>line.match(/("([^"]|"")*"|[^,]*)/g).filter(s=>s!=='').map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"')));
  const header=rows[0].map(h=>h.trim().toLowerCase());
  const qi=header.indexOf('question'), ai=header.indexOf('answer'), ji=header.indexOf('japanese');
  if(qi<0||ai<0||rows.length<2) throw new Error('Sheet needs Question/Answer columns');
  items=rows.slice(1).map(r=>({q:r[qi]||'', a:(r[ai]||'').toLowerCase(), j:r[ji]||''}));
  solved = items.map(()=>false);
  idx=0; render();
})().catch(e=>{document.getElementById('q').textContent='Load error: '+e.message;});

/* ===== 画面更新 ===== */
function render(){
  stop(true);
  const total=items.length||0;
  document.getElementById('q').textContent=items[idx]?.q||'(no question)';
  document.getElementById('prog').textContent=total?`${idx+1}/${total}`:'';
  setScore('');
  setJapanese(null, false);
  setNextEnabled(solved[idx] === true);   // 既に合格済みなら次へOK、初見はNG
}

/* ===== TTS（自然な声を優先選択） ===== */
let preferredVoice = null;
function pickVoice() {
  const voices = speechSynthesis.getVoices();
  // 好みの順に選ぶ（ブラウザやOSにより名称が異なるため候補を列挙）
  const preferredNames = [
    'Google US English', 'Google UK English Female', 'Samantha', 'Karen',
    'Daniel', 'Alex', 'Victoria', 'Moira'
  ];
  preferredVoice =
    voices.find(v => preferredNames.includes(v.name) && v.lang.startsWith('en')) ||
    voices.find(v => v.lang === LANG_VOICE) ||
    voices[0] || null;
}
speechSynthesis.onvoiceschanged = pickVoice;
pickVoice();

document.getElementById('play').onclick=()=>{
  const u=new SpeechSynthesisUtterance(items[idx]?.q||'');
  u.lang=LANG_VOICE;
  if (preferredVoice) u.voice = preferredVoice;
  u.rate = 0.95;   // 少しゆっくり＆自然寄せ
  u.pitch = 1.0;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
};

/* ===== 録音/STT ===== */
let stream,rec,chunks=[],timer,recognizing=false,recog,confirmed='',interim='';
const live=document.getElementById('live');
const finalEl=document.getElementById('final');
const recBtn=document.getElementById('rec');
const nextBtn=document.getElementById('next');

recBtn.onclick=async()=>{ if(!rec||rec.state==='inactive') start(); else stop(); };
nextBtn.onclick=()=>{ if(nextBtn.disabled) return; idx=(idx+1)%items.length; render(); };

async function start(){
  // タイマー開始（最初の録音開始でスタート）
  if (!startTime) { startTime = Date.now(); startTicker(); }

  confirmed=interim=''; finalEl.textContent=''; live.textContent=''; setScore('');
  setJapanese(null,false);
  setNextEnabled(false);

  if('webkitSpeechRecognition'in window||'SpeechRecognition'in window){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    recog=new SR(); recog.lang=LANG_VOICE; recog.interimResults=true; recog.continuous=true;
    recog.onresult=e=>{
      let tmp=''; for(let i=e.resultIndex;i<e.results.length;i++){const r=e.results[i];
        if(r.isFinal){confirmed+=r[0].transcript+'\n';}else{tmp+=r[0].transcript;}}
      interim=tmp; live.textContent=interim; finalEl.textContent=confirmed;
    };
    try{recog.start(); recognizing=true;}catch{}
  }
  stream=await navigator.mediaDevices.getUserMedia({audio:true});
  const mime=MediaRecorder.isTypeSupported('audio/webm')?'audio/webm':'audio/ogg';
  rec=new MediaRecorder(stream,{mimeType:mime}); chunks=[];
  rec.ondataavailable=e=>{if(e.data&&e.data.size)chunks.push(e.data);};
  rec.start(); timer=setInterval(sendChunk,3000);
  recBtn.textContent='🟥 録音中';
}
async function stop(silent=false){
  clearInterval(timer);
  if(rec&&rec.state!=='inactive')rec.stop();
  if(stream)stream.getTracks().forEach(t=>t.stop());
  if(recognizing&&recog){try{recog.stop();}catch{} recognizing=false;}
  if(!silent)recBtn.textContent='🎤 録音開始';
  if(chunks.length&&!silent)await sendChunk();
}
function toBase64(blob){return new Promise((res,rej)=>{const r=new FileReader();r.onloadend=()=>res(r.result);r.onerror=rej;r.readAsDataURL(blob);});}
async function sendChunk(){
  if(!chunks.length)return;
  const blob=new Blob(chunks.splice(0,chunks.length),{type:rec.mimeType});
  const b64=await toBase64(blob);
  const r=await fetch(STT_API,{method:'POST',headers:{'content-type':'application/json'},
    body:JSON.stringify({base64:b64.split(',')[1],mime:rec.mimeType,language:LANG_WHISPER})});
  const j=await r.json().catch(()=>({}));
  if(j&&j.text){confirmed+=j.text+'\n'; finalEl.textContent=confirmed;}
}

/* ===== チェック（日本語表示・次へ制御） ===== */
document.getElementById('grade').onclick=()=>{
  const cand=normalize((confirmed||interim||'').trim());
  const gold=normalize(items[idx]?.a||'');
  const sim=similarity(cand,gold);
  const ok=sim>=PASS_THRESHOLD;

  // 合否表示（合格／残念💦）
  setScore(ok?`✔ 合格（類似度 ${Math.round(sim*100)}%）`
              :`残念💦（類似度 ${Math.round(sim*100)}%）\nあなたの回答: ${cand}\n模範解答: ${gold}`,
           ok?'ok':'ng');

  // 日本語訳の表示
  setJapanese(items[idx]?.j || '(日本語訳が未設定です)', true);

  // 次へボタン制御と完了判定
  solved[idx] = ok || solved[idx];        // 一度合格したら維持
  setNextEnabled(solved[idx]);
  checkAllSolved();
};

function setNextEnabled(enable){
  nextBtn.disabled = !enable;
}

function setScore(text,cls){const el=document.getElementById('score'); el.className=cls||''; el.textContent=text;}

function setJapanese(text, show){
  const card = document.getElementById('jaCard');
  const box  = document.getElementById('ja');
  if (show && text) { box.textContent = text; card.style.display = ''; }
  else { box.textContent = ''; card.style.display = 'none'; }
}

function normalize(s){return s.toLowerCase().replace(/[^\p{Letter}\p{Number}\s]/gu,'').replace(/\s+/g,' ').trim();}
function similarity(a,b){const m=a.length,n=b.length;if(!m&&!n)return 1;const d=Array.from({length:m+1},(_,i)=>[i]);for(let j=1;j<=n;j++)d[0][j]=j;for(let i=1;i<=m;i++){for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1;d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+c);}}const dist=d[m][n];return 1-dist/Math.max(m,n);}

/* ===== タイマー（開始〜全問合格の合計時間） ===== */
function startTicker(){
  const el = document.getElementById('timer');
  function tick
