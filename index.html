<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Listen â†’ Answer â†’ Grade</title>
<style>
  body{font:16px/1.6 system-ui,sans-serif;max-width:780px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  button{padding:10px 16px;border-radius:999px;border:1px solid #ddd;cursor:pointer}
  #live{opacity:.6;white-space:pre-wrap;margin-top:8px}
  #final{white-space:pre-wrap;margin-top:8px}
  #score{font-weight:700;margin-top:12px}
  .ok{color:#0a7a0a}.ng{color:#c01818}
  #q{font-size:18px;margin:6px 0 12px}
</style>

<h2>Question</h2>
<div id="q"></div>
<div class="row">
  <button id="play">ðŸ”Š Play</button>
  <button id="rec">ðŸŽ¤ Start</button>
  <button id="grade">âœ… Grade</button>
</div>

<div id="live"></div>
<div id="final"></div>
<div id="score"></div>

<script>
/* ====== ã“ã“ã‹ã‚‰ç½®æ› ====== */
const SHEET_CSV =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRVC56sLRh94LTed5WD4sVkIojw00CTlBL7yPtJocPewWqQ-ODfFsmLx_k9BX3LOmNT8ztP4GwqJVfl/pub?gid=0&single=true&output=csv';

let QUESTION_TEXT = 'Loading...';
let ANSWER_KEY = '';
const STT_API = '/api/transcribe';

async function loadSheet() {
  const csv = await (await fetch(SHEET_CSV, { cache: 'no-store' })).text();
  // ã‚«ãƒ³ãƒž(ãƒ€ãƒ–ãƒ«ã‚¯ã‚ªãƒ¼ãƒˆå†…ã¯é™¤å¤–)ã§åˆ†å‰²
  const rows = csv.trim().split(/\r?\n/).map(
    line => line.match(/("([^"]|"")*"|[^,]*)/g)
                 .filter(s => s !== '')
                 .map(s => s.replace(/^"|"$/g,'').replace(/""/g,'"'))
  );
  const header = rows[0].map(h => h.trim().toLowerCase());
  const qi = header.indexOf('question');
  const ai = header.indexOf('answer');
  if (qi < 0 || ai < 0 || rows.length < 2) {
    throw new Error('Sheet must have "Question" and "Answer" columns with at least 1 row');
  }
  const first = rows[1];                // å…ˆé ­ã®ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ä½¿ç”¨ï¼ˆå¿…è¦ãªã‚‰è¡Œã‚’å¤‰ãˆã¦ãã ã•ã„ï¼‰
  QUESTION_TEXT = first[qi] || '';
  ANSWER_KEY = (first[ai] || '').toLowerCase();

  document.getElementById('q').textContent = QUESTION_TEXT;
}
loadSheet().catch(e => {
  document.getElementById('q').textContent = 'Load error: ' + e.message;
});
/* ====== ç½®æ›ã“ã“ã¾ã§ ====== */

/* ====== å‡ºé¡Œè¡¨ç¤º ====== */
document.getElementById('q').textContent = QUESTION_TEXT;

/* ====== TTSï¼ˆWeb Speech APIï¼‰ ====== */
const playBtn = document.getElementById('play');
playBtn.onclick = () => {
  const u = new SpeechSynthesisUtterance(QUESTION_TEXT);
  // è‹±èªžã§å‡ºé¡Œã™ã‚‹æƒ³å®šï¼ˆæ—¥æœ¬èªžåŒ–ã—ãŸã„å ´åˆã¯ 'ja-JP'ï¼‰
  u.lang = 'en-US';
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
};

/* ====== æš«å®šå­—å¹• + éŒ²éŸ³ â†’ Whisper ====== */
let stream, rec, chunks=[], timer, recognizing=false, recog;
const live = document.getElementById('live');
const finalEl = document.getElementById('final');
const scoreEl = document.getElementById('score');
let confirmed = '';   // Whisperã®ç¢ºå®šãƒ†ã‚­ã‚¹ãƒˆã‚’è“„ç©
let interim   = '';   // æš«å®šå­—å¹•

const recBtn = document.getElementById('rec');
recBtn.onclick = async ()=>{ if(!rec || rec.state==='inactive') start(); else stop(); };

async function start(){
  scoreEl.textContent = '';
  confirmed = interim = '';
  finalEl.textContent = ''; live.textContent = '';

  // æš«å®šå­—å¹•ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰
  if('webkitSpeechRecognition'in window || 'SpeechRecognition'in window){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recog = new SR();
    recog.lang = 'en-US';            // â†è‹±èªžç·´ç¿’ã€‚æ—¥æœ¬èªžã«ã—ãŸã„æ™‚ã¯ 'ja-JP'
    recog.interimResults = true;
    recog.continuous = true;
    recog.onresult = e=>{
      let tmp='';
      for(let i=e.resultIndex;i<e.results.length;i++){
        const r=e.results[i];
        if(r.isFinal){ confirmed += (r[0].transcript + '\n'); }
        else{ tmp += r[0].transcript; }
      }
      interim = tmp;
      live.textContent = interim;
      finalEl.textContent = confirmed;
    };
    try{ recog.start(); recognizing=true; }catch{}
  }

  // éŒ²éŸ³ï¼ˆ3ç§’ã”ã¨ã«Whisperã¸ï¼‰
  stream = await navigator.mediaDevices.getUserMedia({audio:true});
  const mime = MediaRecorder.isTypeSupported('audio/webm')?'audio/webm':'audio/ogg';
  rec = new MediaRecorder(stream,{mimeType:mime});
  chunks=[];
  rec.ondataavailable=e=>{ if(e.data&&e.data.size) chunks.push(e.data); };
  rec.start();

  timer = setInterval(sendChunk, 3000);
  recBtn.textContent = 'ðŸŸ¥ Stop';
}

async function stop(){
  clearInterval(timer);
  if(rec && rec.state!=='inactive') rec.stop();
  if(stream) stream.getTracks().forEach(t=>t.stop());
  if(recognizing && recog){ try{ recog.stop(); }catch{} }
  recBtn.textContent='ðŸŽ¤ Start';
  if(chunks.length) await sendChunk(); // æ®‹ã‚Šã‚’é€ä¿¡
}

function toBase64(blob){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onloadend=()=>res(r.result);
    r.onerror=rej;
    r.readAsDataURL(blob);
  });
}

async function sendChunk(){
  if(!chunks.length) return;
  const blob = new Blob(chunks.splice(0, chunks.length), { type: rec.mimeType });
  const b64 = await toBase64(blob);
  const r = await fetch(STT_API,{method:'POST',headers:{'content-type':'application/json'},
    body: JSON.stringify({ base64: b64.split(',')[1], mime: rec.mimeType, language: 'en' })});
  const j = await r.json().catch(()=>({}));
  if(j && j.text){ confirmed += j.text + '\n'; finalEl.textContent = confirmed; }
}

/* ====== æŽ¡ç‚¹ ====== */
const gradeBtn = document.getElementById('grade');
gradeBtn.onclick = ()=>{
  const cand = normalize((confirmed || interim || '').trim());
  const gold = normalize(ANSWER_KEY);
  const sim = similarity(cand, gold);   // 0ã€œ1
  const ok  = sim >= 0.85;              // ã—ãã„å€¤ï¼ˆå¿…è¦ãªã‚‰èª¿æ•´ï¼‰
  scoreEl.className = ok ? 'ok' : 'ng';
  scoreEl.textContent = ok
    ? `âœ” Correct (similarity ${Math.round(sim*100)}%)`
    : `âœ– Try again (similarity ${Math.round(sim*100)}%)\nYour answer: ${cand}\nExpected: ${gold}`;
};

function normalize(s){
  return s.toLowerCase()
    .replace(/[^\p{Letter}\p{Number}\s]/gu,'') // è¨˜å·é™¤åŽ»
    .replace(/\s+/g,' ')
    .trim();
}

// ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢â†’é¡žä¼¼åº¦
function similarity(a,b){
  const m=a.length,n=b.length;
  if(!m && !n) return 1;
  const dp=Array.from({length:m+1},(_,i)=>[i]);
  for(let j=1;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1]?0:1;
      dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
  }
  const dist=dp[m][n];
  const maxLen=Math.max(m,n);
  return 1 - dist/maxLen;
}
</script>
